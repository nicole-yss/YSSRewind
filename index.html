<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <title>YSSLoyalty Rewind</title>
  <meta name="theme-color" content="#000000" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bar-bg: rgba(255,255,255,0.25);
      --bar-fg: white;
      --ui-fg: white;
      --ui-muted: rgba(255,255,255,0.75);
      --shadow: 0 8px 30px rgba(0,0,0,.35);
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: #000;
      color: var(--ui-fg);
      font-family: "Instrument Sans", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      overflow: hidden;
    }
    .root { position: relative; width: 100vw; height: 100dvh; background: #000; display: grid; place-items: center; }
    .stage { position: relative; height: 100dvh; aspect-ratio: 9 / 16; max-height: 100dvh; max-width: 100vw; width: auto; background: #000; overflow: hidden; }
    .progress { position: absolute; top: 8px; left: 8px; right: 8px; display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; z-index: 20; pointer-events: auto; }
    .progress .track { height: 3px; background: var(--bar-bg); border-radius: 999px; overflow: hidden; cursor: pointer; }
    .progress .fill { width: 0%; height: 100%; background: var(--bar-fg); transform-origin: left center; transition: width 100ms linear; }
    video#player { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; background: #000; }
    .tapzone { position: absolute; top: 0; bottom: 0; width: 50%; z-index: 15; }
    .left { left: 0; } .right { right: 0; }
    .edge-hint { position:absolute; top:0; bottom:0; width:16%; z-index: 10; pointer-events:none; }
    .edge-left { left:0; background: linear-gradient(90deg, rgba(0,0,0,.35), rgba(0,0,0,0)); }
    .edge-right { right:0; background: linear-gradient(270deg, rgba(0,0,0,.35), rgba(0,0,0,0)); }
    .top-ui { position: absolute; left: 12px; right: 12px; top: 18px; display: flex; align-items: center; justify-content: space-between; z-index: 25; pointer-events: none; }
    .pill { pointer-events: auto; opacity: .9; }
    .btn { appearance: none; border: none; border-radius: 18px; padding: 10px 12px; font-weight: 600; color: #111; background: #fff; box-shadow: var(--shadow); cursor: pointer; }
    .btn.secondary { background: rgba(255,255,255,.15); color: #fff; backdrop-filter: blur(6px); border: 1px solid rgba(255,255,255,.25); }
    .btn.inline { padding: 10px 12px; border-radius: 12px; font-weight: 600; }
    .gate { position: absolute; inset: 0; display: grid; place-items: center; background: rgba(0,0,0,.6); z-index: 30; padding: 24px; text-align: center; }
    .icon-btn { display: inline-grid; place-items: center; width: 64px; height: 64px; border-radius: 999px; background: #fff; color: #111; box-shadow: var(--shadow); cursor: pointer; border: none; }
    .icon-btn svg { width: 28px; height: 28px; }
    .playpause { position: absolute; left: 50%; bottom: calc(env(safe-area-inset-bottom) + 20px); transform: translateX(-50%); z-index: 26; display: grid; place-items: center; }
    .playpause .icon-btn { width: 52px; height: 52px; background: rgba(255,255,255,.9); }
    .share { position: absolute; inset: 0; display: none; z-index: 40; background: linear-gradient(0deg, rgba(0,0,0,.8) 0%, rgba(0,0,0,.2) 45%, rgba(0,0,0,0) 70%); padding: 24px 16px calc(env(safe-area-inset-bottom) + 24px); align-content: end; gap: 12px; }
    .share.visible { display: grid; }
    .share .panel { background: rgba(255,255,255,.1); border: 1px solid rgba(255,255,255,.2); border-radius: 18px; padding: 16px; backdrop-filter: blur(6px); }
    .share h2 { margin: 0 0 6px; font-size: 20px; }
    .share p { margin: 0 0 12px; color: var(--ui-muted); line-height: 1.35; }
    .share .row { display: flex; gap: 10px; flex-wrap: wrap; }
    .spotify { position: absolute; top: 50%; left: 50%; z-index: 45; display: none; opacity: 0; transform: translate(-50%, -50%) scale(0.98); transition: opacity .35s ease, transform .35s ease; width: min(92vw, 560px); border-radius: 12px; overflow: hidden; }
    .spotify.visible { display: block; opacity: 1; transform: translate(-50%, -50%) scale(1); }
      /* Hide the bottom play/pause control entirely */
    .playpause { display: none !important; }
    .gate { display: none !important; }
</style>
</head>
<body>
  <div class="root">
    <div class="stage" id="stage">
      <div class="progress" id="progress"></div>
      <div class="top-ui">
        <div style="display:flex; align-items:center; gap:8px; opacity:.9">
          <div style="width:28px;height:28px;border-radius:999px;background:#fff"></div>
          <div style="font-weight:700">YSSLoyalty Rewind</div>
        </div>
        <div style="display:flex; gap:8px; align-items:center;" class="actions">
          <button id="shareTopBtn" class="btn inline pill">Share…</button>
          <button id="igTopBtn" class="btn inline pill">IG Story</button>
          <button id="replayBtn" class="btn inline pill" style="display:none">Replay</button>
        </div>
      </div>

      <video id="player" playsinline preload="metadata"></video>

      <div class="tapzone left" id="tapLeft" aria-label="Previous story" role="button"></div>
      <div class="tapzone right" id="tapRight" aria-label="Next story" role="button"></div>

      <div class="edge-hint edge-left"></div>
      <div class="edge-hint edge-right"></div>

      <div class="spotify" id="spotifyPanel">
        <iframe data-testid="embed-iframe" style="border-radius:12px" data-src="https://open.spotify.com/embed/playlist/5h8G9staxe6l3dSb8CKU08?utm_source=generator&theme=0" width="100%" height="152" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
      </div>

      <div class="gate" id="gate" aria-label="Play">
        <button class="icon-btn" id="startBtn" aria-label="Play">
          <svg id="gatePlayIcon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M8 5v14l11-7-11-7z" fill="currentColor"/>
          </svg>
        </button>
      </div>

      <div class="playpause" id="playpause">
        <button class="icon-btn" id="ppBtn" aria-label="Pause">
          <svg id="ppPauseIcon" viewBox="0 0 24 24" fill="none">
            <path d="M7 5h4v14H7zM13 5h4v14h-4z" fill="currentColor"/>
          </svg>
          <svg id="ppPlayIcon" viewBox="0 0 24 24" fill="none" style="display:none">
            <path d="M8 5v14l11-7-11-7z" fill="currentColor"/>
          </svg>
        </button>
      </div>

      <div class="share" id="share">
        <div class="panel">
          <h2>Done! Share it</h2>
          <p>Choose Instagram → Story from your Share sheet, or download and upload manually.</p>
          <div class="row">
            <button class="btn" id="shareBtn">Share…</button>
            <button class="btn" id="igBtn">IG Story</button>
            <button class="btn secondary" id="downloadBtn">Download video</button>
          </div>
        </div>
        <button class="btn" id="replayBtn2" style="justify-self:center; margin-top:6px;">Replay</button>
      </div>
    </div>
  </div>

  <script>
  (function () {
    const slides = [
      "https://storage.googleapis.com/yss_media/NURSE%20JEI/%231.mp4",
      "https://storage.googleapis.com/yss_media/NURSE%20JEI/%232.mp4",
      "https://storage.googleapis.com/yss_media/NURSE%20JEI/%233.mp4",
      "https://storage.googleapis.com/yss_media/NURSE%20JEI/%234.mp4",
      "https://storage.googleapis.com/yss_media/NURSE%20JEI/%235.mp4",
    ];

    const stage = document.getElementById('stage');
    const progressRoot = document.getElementById('progress');
    const player = document.getElementById('player');
    const tapLeft = document.getElementById('tapLeft');
    const tapRight = document.getElementById('tapRight');
    const gate = document.getElementById('gate');
    const startBtn = document.getElementById('startBtn');
    const shareOverlay = document.getElementById('share');
    const shareBtn = document.getElementById('shareBtn');
    const igBtn = document.getElementById('igBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const replayBtn = document.getElementById('replayBtn');
    const replayBtn2 = document.getElementById('replayBtn2');
    const spotifyPanel = document.getElementById('spotifyPanel');
    const spotifyIframe = spotifyPanel.querySelector('iframe');
    const ppBtn = document.getElementById('ppBtn');
    const ppPauseIcon = document.getElementById('ppPauseIcon');
    const ppPlayIcon = document.getElementById('ppPlayIcon');
    const shareTopBtn = document.getElementById('shareTopBtn');
    const igTopBtn = document.getElementById('igTopBtn');

    const SPOTIFY_LEAD_S = 2.0;
    let spotifyShown = false;
    let current = 0;
    let raf = null;
    let isPressing = false;
    let touchStartX = null;
    let hasStarted = false;

    const fills = [];
    const tracks = [];
    for (let i = 0; i < slides.length; i++) {
      const track = document.createElement('div');
      track.className = 'track';
      track.setAttribute('role', 'button');
      track.setAttribute('aria-label', 'Jump to story ' + (i + 1));
      const fill = document.createElement('div');
      fill.className = 'fill';
      track.appendChild(fill);
      progressRoot.appendChild(track);
      fills.push(fill);
      tracks.push(track);
      track.addEventListener('click', () => loadSlide(i));
    }

    function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }

    function setPPState(paused) {
      if (paused) {
        ppPauseIcon.style.display = 'none';
        ppPlayIcon.style.display = 'block';
        ppBtn.setAttribute('aria-label', 'Play');
      } else {
        ppPauseIcon.style.display = 'block';
        ppPlayIcon.style.display = 'none';
        ppBtn.setAttribute('aria-label', 'Pause');
      }
    }

    function loadSlide(i, { autoplay = true } = {}) {
      current = clamp(i, 0, slides.length - 1);
      shareOverlay.classList.remove('visible');
      replayBtn.style.display = 'none';
      spotifyPanel.classList.remove('visible');
      spotifyPanel.style.display = 'none';
      spotifyShown = false;

      for (let j = 0; j < slides.length; j++) {
        if (j < current) fills[j].style.width = '100%';
        else fills[j].style.width = '0%';
      }

      const url = slides[current];
      player.src = url;
      player.currentTime = 0;
      player.load();

      const maybePlay = () => {
        if (!autoplay) return;
        const p = player.play();
        if (p && typeof p.catch === 'function') p.catch(() => {});
      };

      if (player.readyState >= 2) {
        maybePlay();
      } else {
        player.addEventListener('loadedmetadata', maybePlay, { once: true });
      }

      cancelAnimationFrame(raf);
      tick();
    }

    function next() { current < slides.length - 1 ? loadSlide(current + 1) : showShare(); }
    function prev() {
      if (player.currentTime > 0.25) player.currentTime = 0;
      else if (current > 0) loadSlide(current - 1);
    }

    function tick() {
      if (player.duration > 0 && isFinite(player.duration)) {
        if (!player.paused) {
          const pct = (player.currentTime / player.duration) * 100;
          fills[current].style.width = clamp(pct, 0, 100) + '%';
        }
        if (!spotifyShown && current === slides.length - 1) {
          const remaining = player.duration - player.currentTime;
          if (remaining <= SPOTIFY_LEAD_S) {
            const src = spotifyIframe.getAttribute('data-src');
            if (src && !spotifyIframe.src) spotifyIframe.src = src;
            spotifyPanel.style.display = 'block';
            requestAnimationFrame(() => spotifyPanel.classList.add('visible'));
            spotifyShown = true;
          }
        }
      }
      raf = requestAnimationFrame(tick);
    }

    function showShare() {
      fills.forEach(f => f.style.width = '100%');
      replayBtn.style.display = 'inline-flex';
      shareOverlay.classList.add('visible');
      try { player.pause(); } catch (e) {}
      setPPState(true);
    }

    tapRight.addEventListener('click', next);
    tapLeft.addEventListener('click', prev);
    player.addEventListener('ended', next);

    const pressStart = (e) => {
      // If playback hasn't started yet, first tap starts it (no buttons)
      if (!hasStarted) {
        hasStarted = true;
        try { startPlayback(); } catch (_) {}
        return;
      }
      if (getComputedStyle(gate).display !== 'none') return;
      if (e && (e.target.closest('.gate') || e.target.closest('.progress') || e.target.closest('button'))) return;
      isPressing = true;
      try { player.pause(); setPPState(true); } catch (e) {}
    };
    const pressEnd = () => { if (!isPressing) return; isPressing = false; try { player.play(); setPPState(false); } catch (e) {} };
    stage.addEventListener('pointerdown', pressStart);
    stage.addEventListener('pointerup', pressEnd);
    stage.addEventListener('pointercancel', pressEnd);
    stage.addEventListener('pointerleave', pressEnd);

    stage.addEventListener('touchstart', (e) => { touchStartX = e.changedTouches[0].clientX; }, { passive: true });
    stage.addEventListener('touchend', (e) => {
      if (touchStartX == null) return;
      const dx = e.changedTouches[0].clientX - touchStartX;
      touchStartX = null;
      const THRESH = 40;
      if (Math.abs(dx) > THRESH) { if (dx < 0) next(); else prev(); }
    });

    window.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowRight') next();
      if (e.key === 'ArrowLeft') prev();
      if (e.key === ' ') { e.preventDefault(); player.paused ? player.play() : player.pause(); }
    });

    document.addEventListener('visibilitychange', () => {
      if (document.hidden) { try { player.pause(); setPPState(true); } catch (e) {} }
    });

    function startPlayback() {
      player.muted = false;
      gate.style.display = 'none';
      loadSlide(current, { autoplay: true });
      setPPState(false);
    }
    gate.addEventListener('click', (e) => { if (e.target.closest('#startBtn')) startPlayback(); });
    startBtn.addEventListener('click', (e) => { e.stopPropagation(); startPlayback(); });

    ppBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      if (player.paused) { player.play(); setPPState(false); }
      else { player.pause(); setPPState(true); }
    });

    function replay() {
      current = 0;
      shareOverlay.classList.remove('visible');
      replayBtn.style.display = 'none';
      spotifyPanel.classList.remove('visible');
      spotifyPanel.style.display = 'none';
      spotifyShown = false;
      loadSlide(0);
      setPPState(false);
    }
    replayBtn.addEventListener('click', replay);
    replayBtn2.addEventListener('click', replay);

    // ---- Helpers for Web Share (files) ----
    async function getCurrentFile() {
      const currentUrl = slides[current];
      // Robust GET with timeout + filename extraction
      const ctrl = new AbortController();
      const timer = setTimeout(() => ctrl.abort(), 15000);
      let filename = (currentUrl.split('/').pop() || 'clip.mp4').replace(/\?.*$/, '');

      try {
        // Try HEAD first for filename & type hints
        try {
          const head = await fetch(currentUrl, { method: 'HEAD', mode: 'cors', signal: ctrl.signal });
          const disp = head.headers.get('content-disposition');
          if (disp && /filename\*=UTF-8''([^;]+)|filename="?([^";]+)"?/i.test(disp)) {
            const m = disp.match(/filename\*=UTF-8''([^;]+)|filename="?([^";]+)"?/i);
            filename = decodeURIComponent(m[1] || m[2]);
          }
        } catch (_) { /* ignore HEAD issues */ }

        const resp = await fetch(currentUrl, { method: 'GET', mode: 'cors', credentials: 'omit', referrerPolicy: 'no-referrer', signal: ctrl.signal });
        if (!resp.ok) throw new Error('http-' + resp.status);
        const blob = await resp.blob();
        clearTimeout(timer);

        // Size sanity check (Instagram often rejects very large files via share sheet)
        // Skip strict enforcement; just proceed. You can enforce if needed.
        const mime = blob.type && blob.type !== 'application/octet-stream' ? blob.type : 'video/mp4';
        if (!/mp4|quicktime|3gpp|x-matroska|webm/i.test(mime)) {
          // Force mp4 container type; many apps expect this
          return new File([blob], filename.endsWith('.mp4') ? filename : (filename + '.mp4'), { type: 'video/mp4' });
        }
        return new File([blob], filename, { type: mime });
      } catch (err) {
        clearTimeout(timer);
        // Last resort: try to fetch without CORS (may be opaque and unusable)
        // Fall back to instructing a manual download
        throw err;
      }
    }

    async function shareViaFiles(file) {
      if (navigator.canShare && navigator.canShare({ files: [file] })) {
        // Keep fields minimal — some targets (Instagram) are picky
        await navigator.share({ files: [file] }).catch(() => {});
        return true;
      }
      return false;
    }

    function triggerDownload(url, filename) {
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    // ---- Generic Web Share button (kept for broad sharing) ----
    async function shareCurrentSlide() {
      const currentUrl = slides[current];
      try {
        const file = await getCurrentFile();
        const ok = await shareViaFiles(file);
        if (ok) return; // User will pick Instagram → Story from the sheet if available
      } catch (e) {
        // fall through to URL share / download
      }

      if (navigator.share) {
        try { await navigator.share({ url: currentUrl }); return; } catch (e) {}
      }
      triggerDownload(currentUrl, (currentUrl.split('/').pop() || 'clip.mp4'));
    }

    // ---- "Share to Instagram Story" (best-effort using Web Share with files) ----
    async function shareToInstagramStory() {
      try {
        // 1) HTTP GET the binary file
        const file = await getCurrentFile();
        // 2) Send binary via Web Share (files) → user picks Instagram → Story
        const ok = await shareViaFiles(file);
        if (!ok) throw new Error('files-share-not-supported');
      } catch (err) {
        const url = slides[current];
        // Fallback: trigger download, user uploads to IG manually
        const fn = (url.split('/').pop() || 'clip.mp4');
        triggerDownload(url, fn);
        alert("Couldn't share directly from the browser. The video has been downloaded — open Instagram and upload it to your Story.");
      }
    }
    }

    shareTopBtn.addEventListener('click', shareCurrentSlide);
    shareBtn.addEventListener('click', shareCurrentSlide);
    downloadBtn.addEventListener('click', () => triggerDownload(slides[current], (slides[current].split('/').pop() || 'clip.mp4')));

    // New: dedicated IG Story buttons (top bar and share panel)
    igTopBtn.addEventListener('click', shareToInstagramStory);
    igBtn.addEventListener('click', shareToInstagramStory);

    // Initial: do not autoplay until user taps
    loadSlide(0, { autoplay: false });
    setPPState(true);
  })();
  </script>
</body>
</html>
